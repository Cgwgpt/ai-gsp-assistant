# 使用统计更新诊断指南

## 问题：使用次数没有统计更新

### 可能的原因

1. **数据库函数未正确部署**
   - `check_and_record_conversation_usage` 函数可能未在数据库中创建
   - 或函数版本不是最新的

2. **前端刷新逻辑问题**
   - 监听可能未正确触发
   - 刷新延迟可能不够

3. **数据库逻辑问题**
   - 全局统计更新可能有问题（已修复）

## 诊断步骤

### 1. 检查数据库函数是否存在

在 Supabase SQL Editor 中执行：

```sql
-- 检查函数是否存在
SELECT 
  proname as function_name,
  prosecdef as is_security_definer,
  pg_get_functiondef(oid) as function_definition
FROM pg_proc 
WHERE proname = 'check_and_record_conversation_usage';
```

**预期结果**：应该返回函数定义

### 2. 测试数据库函数

```sql
-- 替换为实际的用户ID和botID
SELECT check_and_record_conversation_usage(
  'your-user-id-here'::UUID,
  'your-bot-id-here'::UUID
) as function_result;
```

**预期结果**：
- 如果允许：返回 `true`，并记录使用量
- 如果超限：返回 `false`，不记录使用量

### 3. 检查使用量记录

```sql
-- 检查特定数智人的使用量
SELECT * FROM usage_metrics
WHERE user_id = 'your-user-id-here'::UUID
  AND bot_id = 'your-bot-id-here'::UUID
  AND period_start = date_trunc('month', CURRENT_DATE)::DATE
ORDER BY updated_at DESC;

-- 检查全局使用量
SELECT * FROM usage_metrics
WHERE user_id = 'your-user-id-here'::UUID
  AND bot_id IS NULL
  AND period_start = date_trunc('month', CURRENT_DATE)::DATE;
```

### 4. 检查前端日志

打开浏览器控制台，查看以下日志：

1. **消息发送时**：
   ```
   [配额检查] ========== 开始检查并记录用户配额 ==========
   [配额检查] ✅ 配额检查通过，已记录使用量，允许发送消息
   ```

2. **消息发送完成后**：
   ```
   [使用统计] 检测到消息发送完成，自动刷新使用统计
   ```

3. **刷新使用统计时**：
   ```
   刷新数据...
   开始加载用户使用情况
   ```

### 5. 手动测试

1. **发送一条消息**
2. **立即检查数据库**（执行步骤3的SQL）
3. **检查前端是否自动刷新**（查看控制台日志）

## 修复方案

### 如果数据库函数未部署

执行以下SQL文件：

```bash
# 在 Supabase Dashboard SQL Editor 中执行
supabase/migrations/create_usage_metrics.sql
```

或：

```bash
supabase/migrations/fix_check_user_conversation_quota_function.sql
```

### 如果前端未刷新

检查以下内容：

1. **监听是否正确设置**：
   - `components/user/UsageDashboard.vue` 中应该监听 `chatStore.loading`
   - `src/components/user/UsageDashboard.vue` 中应该监听 `chatStore.loading`

2. **chatStore是否正确导入**：
   ```typescript
   import { useChatStore } from '../../stores/chat'  // 或正确的路径
   const chatStore = useChatStore()
   ```

3. **刷新延迟**：
   - 当前设置为500ms延迟，可能需要增加到1000ms

### 如果数据库记录正确但前端未显示

1. **检查 `getUserUsage` 函数**：
   - 确认周期计算正确
   - 确认查询条件正确

2. **检查数据格式**：
   - 确认返回的数据格式符合前端期望

## 常见问题

### Q1: 函数执行成功但使用量未更新

**原因**：可能是全局统计更新逻辑有问题

**解决**：确保使用了最新的SQL函数（已修复全局统计更新逻辑）

### Q2: 前端显示的使用量不准确

**原因**：可能是缓存问题或查询逻辑问题

**解决**：
1. 清除浏览器缓存
2. 检查 `getUserUsage` 函数的查询逻辑
3. 确认周期计算正确

### Q3: 使用量更新延迟

**原因**：前端刷新延迟设置太短

**解决**：增加刷新延迟时间（当前500ms，可增加到1000ms）

## 验证修复

修复后，执行以下测试：

1. ✅ 发送一条消息
2. ✅ 检查数据库中的使用量是否增加
3. ✅ 检查前端使用统计是否自动刷新
4. ✅ 确认显示的使用次数正确

## 相关文件

- `supabase/migrations/create_usage_metrics.sql` - 数据库函数定义
- `supabase/migrations/fix_check_user_conversation_quota_function.sql` - 修复脚本
- `services/usageService.ts` - 服务层实现
- `components/user/UsageDashboard.vue` - 使用统计组件
- `src/components/user/UsageDashboard.vue` - 使用统计组件（src目录）

