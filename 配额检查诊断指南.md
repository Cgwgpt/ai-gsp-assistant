# 配额检查诊断指南

## 问题描述
用户显示"对话次数: 13/10"（已超过限制），但对话仍然可以继续进行。

## 诊断步骤

### 1. 检查浏览器控制台日志

打开浏览器开发者工具（F12），切换到"Console"标签页，然后尝试发送一条消息。您应该看到以下日志：

#### 正常情况下的日志流程：

```
[配额检查] ========== 开始检查用户配额 ==========
[配额检查] 参数: { userId: "...", botId: "..." }
[配额检查] RPC调用结果: { data: false, error: null, dataType: "boolean", ... }
[配额检查] ========== 配额检查结果 ==========
[配额检查] 返回值分析: { rawData: false, dataIsTrue: false, dataIsFalse: true, finalAllowed: false }
[配额检查] ❌ 配额检查未通过，禁止发送消息
[配额检查] 原因: 已超过配额限制
[消息发送] ❌ 配额检查未通过，立即阻止消息发送
[消息发送] allowed值: false 类型: boolean 是否为true: false
[消息发送] 已设置错误状态并返回null，错误信息: 您已达到本月对话次数限制...
```

#### 如果看到这些日志，说明：
- ✅ 配额检查正在执行
- ✅ 数据库函数返回了 `false`（正确）
- ✅ 前端应该阻止了消息发送

### 2. 检查可能的问题

#### 问题A：RPC调用失败（406错误）

如果您看到以下日志：
```
[配额检查] RPC调用结果: { data: null, error: { code: "406", ... } }
[配额检查] ❌ RPC调用失败，禁止发送消息
```

**原因**：数据库函数可能没有正确设置 `SECURITY DEFINER`，或者 RLS 策略阻止了访问。

**解决方法**：
1. 在 Supabase SQL 编辑器中运行以下 SQL：
```sql
-- 确保函数使用了 SECURITY DEFINER
CREATE OR REPLACE FUNCTION check_user_conversation_quota(
  p_user_id UUID,
  p_bot_id UUID
) RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
-- ... (函数体见 fix_check_user_conversation_quota_function.sql)
$$;
```

#### 问题B：数据库函数返回 null

如果您看到：
```
[配额检查] RPC调用结果: { data: null, error: null, ... }
[配额检查] 返回值分析: { rawData: null, dataIsNull: true, finalAllowed: false }
```

**原因**：数据库函数可能返回了 `null` 而不是 `false`。

**解决方法**：数据库函数应该明确返回 `true` 或 `false`，不应该返回 `null`。

#### 问题C：allowed 值为 true（不应该）

如果您看到：
```
[配额检查] 返回值分析: { rawData: true, dataIsTrue: true, finalAllowed: true }
[消息发送] ✅ 配额检查通过，允许继续发送消息
```

**原因**：数据库函数逻辑可能有误，或者数据不同步。

**需要检查**：
1. 数据库中的 `usage_metrics` 表，确认 `conversation_count` 是否正确
2. 数据库中的 `user_quotas` 表，确认 `max_conversations` 是否正确
3. 数据库函数是否正确执行了查询

### 3. 直接在数据库中测试函数

在 Supabase SQL 编辑器中运行：

```sql
-- 替换为实际的用户ID和botID
SELECT check_user_conversation_quota(
  'your-user-id-here'::UUID,
  'your-bot-id-here'::UUID
);
```

**预期结果**：
- 如果使用量 >= 配额，应该返回 `false`
- 如果使用量 < 配额，应该返回 `true`

### 4. 检查数据库数据

```sql
-- 检查用户的配额设置
SELECT * FROM user_quotas 
WHERE user_id = 'your-user-id-here'::UUID;

-- 检查用户的使用量统计
SELECT * FROM usage_metrics 
WHERE user_id = 'your-user-id-here'::UUID 
  AND bot_id = 'your-bot-id-here'::UUID
  AND period_start = date_trunc('month', CURRENT_DATE)::DATE;
```

确认：
- `user_quotas.max_conversations` 是否为 10
- `usage_metrics.conversation_count` 是否为 13

### 5. 检查是否有其他代码路径

确认所有消息发送都通过以下函数：
- `chatStore.sendMessageWithBot()` - 已包含配额检查
- `useGspChatStore.sendMessage()` - 已包含配额检查

## 常见问题

### Q1: 为什么配额检查后消息仍然发送了？

**可能原因**：
1. 配额检查的返回值没有被正确处理
2. 消息在配额检查之前就已经添加到 UI 中
3. 存在其他代码路径绕过了检查

**解决方法**：
- 检查控制台日志，确认 `[消息发送]` 日志显示的状态
- 确认 `allowed !== true` 的检查是否执行

### Q2: 数据库函数返回了什么值？

查看控制台中的 `[配额检查] RPC调用结果` 日志，确认 `data` 字段的值。

### Q3: 如何确认数据库函数已正确部署？

在 Supabase SQL 编辑器中运行：
```sql
SELECT proname, prosecdef 
FROM pg_proc 
WHERE proname = 'check_user_conversation_quota';
```

`prosecdef` 应该为 `true`（表示使用了 SECURITY DEFINER）。

## 需要提供的信息

如果问题仍然存在，请提供：

1. **浏览器控制台日志**（完整复制，包括所有 `[配额检查]` 和 `[消息发送]` 相关的日志）
2. **数据库函数测试结果**（在 Supabase SQL 编辑器中运行函数的结果）
3. **数据库查询结果**（`user_quotas` 和 `usage_metrics` 表的数据）
