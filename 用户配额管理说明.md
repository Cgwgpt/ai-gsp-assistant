# 用户配额管理说明

## 概述

本项目实现了完整的用户配额管理系统，支持对话次数限制和Token使用限制。系统支持全局配额和针对特定数智人的配额设置。

---

## 1. 新用户注册时的配额初始化

### 1.1 注册流程

用户在注册时（`src/components/auth/Register.vue`）：
- 填写用户名、手机号、邮箱、单位名称、密码等信息
- 系统默认角色设置为 `user`
- **自动创建默认配额记录**：对话次数限制5次，Token无限制
- **自动授权所有数智人**：新用户可立即使用所有数智人

### 1.2 默认配额行为

**2024年更新：** 用户注册时会自动创建默认配额记录：
- **对话次数限制：5次**
- **Token限制：无限制（-1）**
- **数智人授权：自动授权所有数智人**

实现位置：`src/components/auth/Register.vue` 的 `handleRegister()` 方法

#### 历史行为（已弃用）
当新注册用户尚未设置配额时（如果没有自动创建配额记录）：
- 系统会返回**默认配额：无限制**
  - `max_conversations: -1` （-1表示无限制）
  - `max_tokens: -1` （-1表示无限制）
- 实现位置：`services/usageService.ts` 的 `getUserQuota()` 方法

```typescript
// 如果没有找到配额记录，返回默认配额（无限制）
if (!data) {
  return { 
    data: { 
      user_id: userId, 
      bot_id: botId,
      max_conversations: -1,  // 无限制
      max_tokens: -1         // 无限制
    } as UserQuota, 
    error: null 
  }
}
```

---

## 2. 配额管理机制

### 2.1 数据库结构

#### 2.1.1 用户配额表 (`user_quotas`)

```sql
CREATE TABLE user_quotas (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,           -- 用户ID
  bot_id UUID,                     -- 数智人ID（null表示全局配额）
  max_conversations INTEGER DEFAULT -1,  -- 对话次数限制（-1表示无限制）
  max_tokens INTEGER DEFAULT -1,         -- Token限制（-1表示无限制）
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE(user_id, bot_id)          -- 确保一个用户对一个数智人只有一个配额记录
)
```

#### 2.1.2 使用统计表 (`usage_metrics`)

```sql
CREATE TABLE usage_metrics (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,           -- 用户ID
  bot_id UUID,                     -- 数智人ID（null表示全局统计）
  conversation_count INTEGER DEFAULT 0,  -- 对话次数
  token_count INTEGER DEFAULT 0,        -- Token使用量
  period_start DATE NOT NULL,            -- 统计周期开始日期
  period_end DATE NOT NULL,              -- 统计周期结束日期
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE(user_id, bot_id, period_start, period_end)  -- 按周期统计
)
```

### 2.2 配额类型

系统支持两种配额类型：

1. **全局配额** (`bot_id = null`)
   - 适用于用户对所有数智人的总体限制
   - 优先级低于特定数智人配额

2. **特定数智人配额** (`bot_id != null`)
   - 针对特定数智人的配额限制
   - 优先级高于全局配额

### 2.3 配额查询逻辑

系统按以下优先级查询配额：

```66:77:services/usageService.ts
      // 如果没有找到配额记录，返回默认配额（无限制）
      if (!data) {
        return { 
          data: { 
            user_id: userId, 
            bot_id: botId,
            max_conversations: -1, 
            max_tokens: -1 
          } as UserQuota, 
          error: null 
        }
      }
```

1. 先查询特定数智人的配额
2. 如果不存在，查询全局配额
3. 如果都不存在，返回默认配额（无限制）

---

## 3. 对话次数限制

### 3.1 限制检查

在创建新对话时（`services/conversationService.ts`），系统会检查用户是否超出对话次数限制：

```96:107:services/conversationService.ts
      // 检查用户是否超出对话配额
      const { allowed, error: quotaError } = await usageService.checkConversationQuota(user.value.id, botId)
      
      if (quotaError) {
        console.error('检查用户对话配额失败:', quotaError)
        // 继续执行，但记录错误
      } else if (!allowed) {
        return { 
          data: null, 
          error: new Error('您已达到本月对话次数限制，请联系管理员增加配额或等待下个月重置') 
        }
      }
```

### 3.2 数据库函数检查

系统使用数据库函数 `check_user_conversation_quota()` 进行检查：

- 查询用户配额（优先特定数智人，后全局）
- 如果配额为 `-1` 或 `null`，返回允许（无限制）
- 查询当前月份的使用量
- 比较使用量是否小于配额限制

### 3.3 使用量记录

每次创建对话时，系统会记录使用量：

```121:133:services/conversationService.ts
      // 记录对话使用量统计
      try {
        const { success, error: usageError } = await usageService.recordConversationUsage(user.value.id, botId)
        if (usageError) {
          console.error('记录对话使用量失败:', usageError)
        } else if (!success) {
          console.warn('记录对话使用量可能未完成')
        } else {
          console.log('对话使用量记录成功')
        }
      } catch (usageErr) {
        console.error('记录对话使用量异常:', usageErr)
      }
```

### 3.4 统计周期

- **统计周期**：按月统计
- **周期计算**：每月1日至当月最后一天
- **自动重置**：每月1日自动重新开始统计

---

## 4. Token限制

### 4.1 Token使用量记录

在每次发送消息后，如果是助手回复，系统会记录Token使用量：

```182:209:services/conversationService.ts
      // 如果是助手回复，记录token使用量
      if (role === 'assistant') {
        try {
          const { user } = useSupabase()
          if (user.value && conversation.bot_id) {
            // 同步记录token使用量
            try {
              const { success, error: usageError } = await usageService.recordTokenUsage(
                user.value.id, 
                conversation.bot_id, 
                tokens
              )
              
              if (usageError) {
                console.error('记录Token使用量失败:', usageError)
              } else if (!success) {
                console.warn('记录Token使用量可能未完成')
              } else {
                console.log('Token使用量记录成功')
              }
            } catch (usageErr) {
              console.error('记录Token使用量异常:', usageErr)
            }
          }
        } catch (err) {
          console.error('处理Token使用量过程出错:', err)
        }
      }
```

### 4.2 Token估算方法

```145:146:services/conversationService.ts
      // 估算token数量（简单实现）
      const tokens = Math.ceil(content.length / 4)
```

Token数量估算：`tokens = Math.ceil(content.length / 4)`

### 4.3 Token限制检查

Token限制在以下场景进行检查：

1. **使用状态查询**：`getUserUsageStatus()` 方法会返回Token使用百分比和是否达到限制
2. **配额验证**：在创建对话或发送消息时，系统会检查当前使用量是否超出Token限制

```1119:1124:services/usageService.ts
        hasConversationLimit: quota.max_conversations > 0,
        // 修改这里：当max_tokens > 0时才有限制
        hasTokenLimit: quota.max_tokens > 0,
        // 修改这里：只有当设置了限制且达到限制时才标记为到达限制
        reachedConversationLimit: quota.max_conversations > 0 && usage.conversation_count >= quota.max_conversations,
        reachedTokenLimit: quota.max_tokens > 0 && usage.token_count >= quota.max_tokens
```

---

## 5. 配额管理界面

### 5.1 管理员配额管理

管理员可以通过 `src/components/admin/UsageQuotaManager.vue` 组件管理用户配额：

- **查看所有用户配额**
- **添加新配额**：可选择全局配额或特定数智人配额
- **编辑配额**：修改对话次数限制和Token限制
- **删除配额**：删除后将使用默认配额（无限制）

### 5.2 配额设置

配额表单字段：

```368:373:src/components/admin/UsageQuotaManager.vue
const quotaForm = ref({
  user_id: '',
  bot_id: null,
  max_conversations: -1,
  max_tokens: -1
})
```

- **对话次数限制**：输入正整数，`-1` 表示无限制
- **Token限制**：输入正整数，`-1` 表示无限制

---

## 6. 用户使用状态查询

### 6.1 使用状态信息

`getUserUsageStatus()` 方法返回用户使用状态：

```1113:1125:services/usageService.ts
      const result = {
        quota,
        usage,
        conversationPercent,
        tokenPercent,
        // 修改这里：当max_conversations > 0时才有限制
        hasConversationLimit: quota.max_conversations > 0,
        // 修改这里：当max_tokens > 0时才有限制
        hasTokenLimit: quota.max_tokens > 0,
        // 修改这里：只有当设置了限制且达到限制时才标记为到达限制
        reachedConversationLimit: quota.max_conversations > 0 && usage.conversation_count >= quota.max_conversations,
        reachedTokenLimit: quota.max_tokens > 0 && usage.token_count >= quota.max_tokens
      }
```

包含信息：
- 配额设置（`quota`）
- 当前使用量（`usage`）
- 对话次数使用百分比（`conversationPercent`）
- Token使用百分比（`tokenPercent`）
- 是否设置了限制（`hasConversationLimit`、`hasTokenLimit`）
- 是否达到限制（`reachedConversationLimit`、`reachedTokenLimit`）

### 6.2 用户使用面板

用户在 `components/user/UsageDashboard.vue` 中可查看：

- 对话次数：显示已使用次数 / 限制次数（或"无限制"）
- Token使用量：显示已使用量 / 限制量（或"无限制"）
- 进度条：可视化显示使用百分比
- 警告提示：达到限制时显示提示信息

---

## 7. 配额管理API

### 7.1 主要方法

在 `services/usageService.ts` 中提供以下方法：

1. **`getUserQuota(userId, botId?)`**：获取用户配额
2. **`setUserQuota(quota)`**：设置用户配额（创建或更新）
3. **`getAllUserQuotas()`**：获取所有用户配额（管理员）
4. **`deleteUserQuota(quotaId)`**：删除配额
5. **`getUserUsage(userId, botId?)`**：获取用户使用量
6. **`recordConversationUsage(userId, botId)`**：记录对话使用量
7. **`recordTokenUsage(userId, botId, tokensUsed)`**：记录Token使用量
8. **`checkConversationQuota(userId, botId)`**：检查对话配额
9. **`getUserUsageStatus(userId, botId?)`**：获取用户使用状态

---

## 8. 关键特性总结

### 8.1 默认行为
- ✅ 新注册用户默认无配额限制（-1）
- ✅ 管理员可手动设置配额

### 8.2 配额类型
- ✅ 支持全局配额（适用于所有数智人）
- ✅ 支持特定数智人配额（优先级更高）

### 8.3 限制检查
- ✅ 对话次数限制：创建对话时检查
- ✅ Token限制：记录在消息发送后
- ✅ 按月周期统计和重置

### 8.4 使用统计
- ✅ 按用户、数智人、周期统计
- ✅ 支持全局统计和特定数智人统计
- ✅ 自动汇总多个数智人的使用量

### 8.5 权限控制
- ✅ 管理员可管理所有用户配额
- ✅ 用户可查看自己的配额和使用量
- ✅ 使用Row Level Security (RLS) 保护数据

---

## 9. 注意事项

1. **新用户默认配额**：新注册用户自动创建配额记录，对话次数限制为5次，Token无限制，并自动授权所有数智人
2. **配额优先级**：特定数智人配额 > 全局配额 > 默认配额（无限制）
3. **统计周期**：使用量按月统计，每月1日自动重置
4. **Token估算**：目前使用简单估算方法（字符长度/4），可能需要优化
5. **配额检查时机**：对话次数在创建对话时检查，Token在消息发送后记录

---

## 10. 已实现的功能改进

1. ✅ **注册时自动创建默认配额**：已在用户注册时自动创建默认配额记录（对话次数限制5次，Token无限制）
2. ✅ **数智人自动授权**：新注册用户自动授权所有数智人

## 11. 建议改进

1. **Token精确计算**：使用更准确的Token计算方法（如tiktoken库）
2. **配额预警**：当用户使用量接近限制时，发送提醒通知
3. **配额模板**：为不同用户类型提供配额模板，便于批量设置
4. **可配置的默认配额**：将默认配额配置化，便于管理员调整

