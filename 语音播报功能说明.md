# 语音播报功能说明

## ✨ 功能概述

项目已成功集成语音播报功能，AI 对话的回复内容可以通过语音朗读出来，支持播放、暂停、停止等操作。

## 🎯 功能特点

### 核心功能
- ✅ **播放/暂停** - 点击播放按钮开始朗读，再次点击暂停
- ✅ **停止播放** - 完全停止当前播放
- ✅ **智能文本处理** - 自动清理 Markdown 语法和代码块
- ✅ **状态指示** - 图标动态变化显示当前状态
- ✅ **浏览器兼容** - 自动检测浏览器支持情况

### 用户体验
- 🎨 **简洁图标** - 使用直观的播放、暂停、停止图标
- 🔄 **状态切换** - 播放时显示高亮蓝色背景
- 📱 **响应式设计** - 支持桌面端和移动端
- ⚡ **即点即用** - 无需配置，开箱即用

## 🎮 使用方式

### 基本操作

1. **开始播放**
   - 鼠标悬停在 AI 回复上
   - 点击右上角的"喇叭"图标
   - 系统开始朗读内容

2. **暂停播放**
   - 播放中，点击"暂停"图标（圆圈内双竖线）
   - 内容暂停，可点击继续播放

3. **继续播放**
   - 暂停后，点击"播放"图标（圆圈内三角形）
   - 从暂停位置继续朗读

4. **停止播放**
   - 播放或暂停时，点击"停止"图标（圆圈内方块）
   - 完全停止，重新播放将从头开始

## 🎨 图标说明

### 播放图标 🔊
```
状态：未播放或已停止
图标：喇叭带声波
颜色：灰色（默认）
说明：点击开始播放
```

### 暂停图标 ⏸️
```
状态：正在播放
图标：圆圈内双竖线
颜色：蓝色（高亮）
说明：点击暂停播放
```

### 继续图标 ▶️
```
状态：已暂停
图标：圆圈内三角形
颜色：蓝色（高亮）
说明：点击继续播放
```

### 停止图标 ⏹️
```
状态：播放或暂停时显示
图标：圆圈内方块
颜色：红色
说明：点击完全停止
```

## 🛠️ 技术实现

### 文件结构

```
src/
├── composables/
│   └── useSpeech.ts                  # 语音播报核心逻辑
└── components/
    ├── gsp/
    │   └── GspReportInterface.vue    # GSP报告界面（已集成）
    └── bot/
        └── BotSelectorInterface.vue  # 多数智人对话界面（已集成）
```

### 核心 API

**`useSpeech()` Composable**

```typescript
const speech = useSpeech()

// 状态
speech.status          // 'idle' | 'playing' | 'paused'
speech.isSupported     // 是否支持语音播报

// 方法
speech.speak(text)     // 播放文本
speech.pause()         // 暂停播放
speech.resume()        // 恢复播放
speech.stop()          // 停止播放
speech.toggle(text)    // 切换播放/暂停
```

### Web Speech API

使用浏览器原生的 Web Speech API（Speech Synthesis）：

```javascript
const utterance = new SpeechSynthesisUtterance(text)
utterance.lang = 'zh-CN'  // 中文
utterance.rate = 1.0      // 语速
utterance.pitch = 1.0     // 音调
utterance.volume = 1.0    // 音量

window.speechSynthesis.speak(utterance)
```

## 📝 文本处理

### 智能清理

播放前自动清理以下内容：

1. **代码块**
   - 行内代码：`` `code` ``
   - 代码块：` ```javascript ... ``` `
   - 替换为："代码块"

2. **Markdown 语法**
   - 标题标记：`# ## ###`
   - 粗体斜体：`**bold** *italic*`
   - 删除线：`~~text~~`
   - 列表标记：`- * 1.`
   - 引用标记：`>`

3. **链接和图片**
   - 链接：`[text](url)` → 保留 `text`
   - 图片：`![alt](url)` → 删除

4. **HTML 标签**
   - 所有 HTML 标签被移除

5. **表格**
   - 表格内容被删除

### 处理示例

**原始 Markdown：**
```markdown
## 整改报告

**主要问题：**
- 培训不足
- 制度缺失

参考[GSP规范](https://example.com)

\```javascript
const code = "example"
\```
```

**处理后文本：**
```
整改报告

主要问题：
培训不足
制度缺失

参考GSP规范

代码块
```

## 🌐 浏览器支持

### 完全支持
- ✅ Chrome 33+
- ✅ Edge 14+
- ✅ Safari 7+
- ✅ Opera 21+

### 部分支持
- ⚠️ Firefox 49+ （需要启用设置）
- ⚠️ iOS Safari （系统语音）

### 不支持
- ❌ IE 11 及以下

### 检测方式

系统自动检测浏览器支持情况：

```javascript
if ('speechSynthesis' in window) {
  // 支持语音播报
} else {
  // 不支持，隐藏按钮或显示提示
}
```

不支持的浏览器中，语音播报按钮不会显示。

## 🎛️ 可配置参数

### 语速调整

在 `src/composables/useSpeech.ts` 中修改：

```typescript
utterance.rate = 1.0  // 默认值
// 0.1 - 10 (0.5=慢速, 1.0=正常, 2.0=快速)
```

### 音调调整

```typescript
utterance.pitch = 1.0  // 默认值
// 0 - 2 (0.5=低音, 1.0=正常, 2.0=高音)
```

### 音量调整

```typescript
utterance.volume = 1.0  // 默认值
// 0 - 1 (0.5=50%, 1.0=100%)
```

### 语言设置

```typescript
utterance.lang = 'zh-CN'  // 简体中文
// 其他选项：
// 'zh-TW' - 繁体中文
// 'en-US' - 英语（美国）
// 'ja-JP' - 日语
```

## 📱 已集成的界面

### 1. GSP 报告撰写界面

**位置：** AI 回复的右上角

**按钮：**
- 🔊 播放/暂停按钮（左侧）
- ⏹️ 停止按钮（播放时显示）
- 📋 复制按钮（右侧）

**特点：**
- 自动过滤问题描述区域
- 只显示在智能撰写的回复上
- 不会在流式输出时显示

### 2. 多数智人对话界面

**位置：** AI 数智人回复的右上角

**按钮：**
- 🔊 播放/暂停按钮（左侧）
- ⏹️ 停止按钮（播放时显示）
- 📋 复制按钮（右侧）

**特点：**
- 只在 AI 回复上显示
- 用户消息不显示语音按钮
- 支持多个数智人的回复

## 🎯 使用场景

### 适合场景

1. **长文本阅读**
   - AI 生成的长篇报告
   - 详细的整改建议
   - 复杂的技术说明

2. **多任务操作**
   - 边听边记录
   - 听内容同时查看其他资料
   - 腾出眼睛做其他事情

3. **辅助功能**
   - 视觉疲劳时使用
   - 阅读困难用户
   - 学习和记忆辅助

### 不适合场景

1. **代码密集内容**
   - 纯代码块（会跳过）
   - 技术参数列表

2. **表格数据**
   - 复杂表格（会删除）
   - 数据统计表

3. **安静环境**
   - 图书馆、会议室等
   - 需要静音的场合

## 💡 使用技巧

### 技巧 1：边听边看

播放时可以滚动查看内容，帮助理解和记忆。

### 技巧 2：分段播放

对于长文本：
1. 播放第一段
2. 停止
3. 思考和消化
4. 继续播放下一段

### 技巧 3：调整语速

根据内容难度调整语速：
- 复杂内容：0.8 倍速
- 普通内容：1.0 倍速
- 熟悉内容：1.5 倍速

### 技巧 4：配合字幕

播放时查看文本内容，加深理解。

## 🐛 常见问题

### Q1: 为什么没有声音？

**可能原因：**
1. 浏览器音量被关闭
2. 系统音量被静音
3. 文本内容为空或只有代码

**解决方案：**
- 检查浏览器和系统音量
- 确认内容包含可朗读的文字
- 重新加载页面

### Q2: 为什么没有播放按钮？

**可能原因：**
浏览器不支持 Web Speech API

**解决方案：**
- 使用 Chrome、Edge 或 Safari
- 更新浏览器到最新版本
- 在 Firefox 中启用语音功能

### Q3: 语音听起来很机械？

**说明：**
使用的是浏览器内置的 TTS 引擎，声音质量取决于：
- 操作系统的语音引擎
- 浏览器的实现方式
- 可用的语音包

**改善方法：**
- Windows：安装更好的语音包
- macOS：系统自带高质量中文语音
- 调整语速和音调参数

### Q4: 播放突然停止？

**可能原因：**
1. 文本过长触发浏览器限制
2. 页面切换或刷新
3. 浏览器资源限制

**解决方案：**
- 分段播放长文本
- 避免在播放时切换页面
- 重新开始播放

### Q5: 可以选择不同的声音吗？

**当前状态：**
使用系统默认中文语音

**未来计划：**
可以添加语音选择功能：

```typescript
const voices = speechSynthesis.getVoices()
utterance.voice = voices.find(v => v.lang === 'zh-CN')
```

## 🔧 高级定制

### 添加语音选择

```typescript
// 获取可用语音
const getVoices = () => {
  return speechSynthesis.getVoices()
    .filter(voice => voice.lang.startsWith('zh'))
}

// 设置语音
const setVoice = (voiceName: string) => {
  const voices = getVoices()
  const voice = voices.find(v => v.name === voiceName)
  if (voice && currentUtterance.value) {
    currentUtterance.value.voice = voice
  }
}
```

### 添加进度条

```typescript
utterance.onboundary = (event) => {
  const progress = event.charIndex / text.length
  console.log(`播放进度: ${(progress * 100).toFixed(0)}%`)
}
```

### 添加速度控制

```vue
<template>
  <input 
    type="range" 
    min="0.5" 
    max="2" 
    step="0.1" 
    v-model="speechRate"
  />
</template>

<script setup>
const speechRate = ref(1.0)

watch(speechRate, (newRate) => {
  if (currentUtterance.value) {
    currentUtterance.value.rate = newRate
  }
})
</script>
```

## 📊 性能考虑

### 内存使用
- ✅ 自动清理：播放结束后释放资源
- ✅ 单例模式：同时只播放一个语音
- ✅ 组件卸载：自动停止播放

### 响应速度
- ✅ 即时响应：点击立即执行
- ✅ 文本预处理：播放前处理一次
- ✅ 状态同步：实时更新图标状态

### 兼容性处理
- ✅ 特性检测：自动检测支持情况
- ✅ 优雅降级：不支持时隐藏按钮
- ✅ 错误处理：播放失败不影响其他功能

## 🎉 总结

### ✅ 已实现功能

- 完整的播放、暂停、停止控制
- 智能的 Markdown 文本清理
- 直观的图标状态显示
- 两个主要对话界面集成
- 浏览器兼容性检测
- 自动资源管理

### 📝 使用简单

- 点击播放即可使用
- 无需任何配置
- 界面简洁直观
- 响应速度快

### 🚀 技术可靠

- 使用原生 Web API
- 无需第三方依赖
- 自动错误处理
- 性能优化完善

现在你的 AI 对话系统已经支持完整的语音播报功能了！🎊

---

**创建日期：** 2024年10月29日  
**功能状态：** ✅ 完成并测试  
**浏览器支持：** Chrome, Edge, Safari, Opera

