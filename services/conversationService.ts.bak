import { useSupabase } from '../composables/useSupabase'
import { usageService } from './usageService'

export interface Message {
  id?: string
  conversation_id: string
  role: 'user' | 'assistant'
  content: string
  tokens?: number
  timestamp: string
}

export interface Conversation {
  id?: string
  title: string
  bot_id: string
  user_id?: string
  is_archived?: boolean
  created_at?: string
  updated_at?: string
  messages?: Message[]
  bot?: {
    name: string
    coze_bot_id: string
    api_key: string
  }
}

export const conversationService = {
  // 获取用户的对话列表
  async getConversations(botId?: string) {
    const { supabase, user } = useSupabase()
    
    if (!user.value) return { data: [], error: new Error('用户未登录') }
    
    try {
      let query = supabase
        .from('conversations')
        .select('*, bots(name, coze_bot_id)')
        .eq('user_id', user.value.id)
        .eq('is_archived', false)
        .order('updated_at', { ascending: false })
      
      if (botId) {
        query = query.eq('bot_id', botId)
      }
      
      const { data, error } = await query
      
      if (error) {
        console.error('获取对话列表失败:', error)
        return { data: [], error }
      }
      
      return { data: data || [], error: null }
    } catch (err) {
      console.error('获取对话列表出错:', err)
      return { data: [], error: err }
    }
  },
  
  // 获取单个对话及其消息
  async getConversation(id: string) {
    const { supabase } = useSupabase()
    
    // 获取对话信息
    const { data: conversation, error: convError } = await supabase
      .from('conversations')
      .select('*, bots(name, coze_bot_id, api_key)')
      .eq('id', id)
      .single()
      
    if (convError) return { error: convError }
    
    // 获取对话消息
    const { data: messages, error: msgError } = await supabase
      .from('messages')
      .select('*')
      .eq('conversation_id', id)
      .order('timestamp', { ascending: true })
      
    if (msgError) return { error: msgError }
    
    return { 
      conversation, 
      messages 
    }
  },
  
  // 创建新对话
  async createConversation(botId: string, title: string) {
    const { supabase, user } = useSupabase()
    
    if (!user.value) return { data: null, error: new Error('用户未登录') }
    
    try {
      console.log(`创建对话: 用户=${user.value.id}, 数智人=${botId}, 标题=${title}`)
      
      // 检查用户是否超出对话配额
      const { allowed, error: quotaError } = await usageService.checkConversationQuota(user.value.id, botId)
      
      if (quotaError) {
        console.error('检查用户对话配额失败:', quotaError)
        // 继续执行，但记录错误
      } else if (!allowed) {
        return { 
          data: null, 
          error: new Error('您已达到本月对话次数限制，请联系管理员增加配额或等待下个月重置') 
        }
      }
      
      // 创建本地对话（不保存到Supabase）
      const id = `local-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`
      const conversation = {
        id,
        title,
        bot_id: botId,
        user_id: user.value.id,
        is_archived: false,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        messages: []
      }
      
      // 记录使用量统计
      try {
        const { success, error: usageError } = await usageService.recordConversationUsage(user.value.id, botId)
        if (usageError) {
          console.error('记录对话使用量失败:', usageError)
          // 即使记录失败也继续返回对话数据
        } else if (!success) {
          console.warn('记录对话使用量可能未完成')
        } else {
          console.log('对话使用量记录成功')
        }
      } catch (usageErr) {
        console.error('记录对话使用量异常:', usageErr)
      }
      
      return { data: conversation, error: null }
    } catch (err) {
      console.error('创建对话出错:', err)
      return { data: null, error: err }
    }
  },
  
  // 添加消息到对话
  async addMessage(conversationId: string, role: 'user' | 'assistant', content: string) {
    const { supabase } = useSupabase()
    
    try {
      // 估算token数量（简单实现）
      const tokens = Math.ceil(content.length / 4)
      
      console.log(`添加消息: 对话=${conversationId}, 角色=${role}, 估算tokens=${tokens}`)
      
      // 添加消息
      const { data, error } = await supabase
        .from('messages')
        .insert([{
          conversation_id: conversationId,
          role,
          content,
          tokens,
          timestamp: new Date().toISOString()
        }])
        .select()
      
      if (error) {
        console.error('添加消息失败:', error)
        return { data: null, error }
      }
        
      // 更新对话的更新时间
      await supabase
        .from('conversations')
        .update({ updated_at: new Date().toISOString() })
        .eq('id', conversationId)
      
      // 如果是助手回复，记录token使用量
      if (role === 'assistant' && data && data.length > 0) {
        try {
          console.log(`助手回复，记录token使用量: ${tokens}`)
          
          // 获取对话信息，以获取用户ID和数智人ID
          const { data: conversation, error: convError } = await supabase
            .from('conversations')
            .select('user_id, bot_id')
            .eq('id', conversationId)
            .single()
          
          if (convError) {
            console.error('获取对话信息失败:', convError)
            return { data, error: null }
          }
          
          if (conversation) {
            // 同步记录token使用量
            try {
              const { success, error: usageError } = await usageService.recordTokenUsage(
                conversation.user_id, 
                conversation.bot_id, 
                tokens
              )
              
              if (usageError) {
                console.error('记录Token使用量失败:', usageError)
              } else if (!success) {
                console.warn('记录Token使用量可能未完成')
              } else {
                console.log('Token使用量记录成功')
              }
            } catch (usageErr) {
              console.error('记录Token使用量异常:', usageErr)
            }
          }
        } catch (err) {
          console.error('处理Token使用量过程出错:', err)
        }
      }
      
      return { data, error: null }
    } catch (err) {
      console.error('添加消息出错:', err)
      return { data: null, error: err }
    }
  },
  
  // 更新对话标题
  async updateConversationTitle(id: string, title: string) {
    const { supabase } = useSupabase()
    
    try {
      const { data, error } = await supabase
        .from('conversations')
        .update({ title, updated_at: new Date().toISOString() })
        .eq('id', id)
        .select()
      
      if (error) {
        console.error('更新对话标题失败:', error)
        return { data: null, error }
      }
      
      return { data: data?.[0] || null, error: null }
    } catch (err) {
      console.error('更新对话标题出错:', err)
      return { data: null, error: err }
    }
  },
  
  // 归档对话
  async archiveConversation(id: string) {
    const { supabase } = useSupabase()
    
    try {
      const { data, error } = await supabase
        .from('conversations')
        .update({ is_archived: true, updated_at: new Date().toISOString() })
        .eq('id', id)
        .select()
      
      if (error) {
        console.error('归档对话失败:', error)
        return { data: null, error }
      }
      
      return { data: data?.[0] || null, error: null }
    } catch (err) {
      console.error('归档对话出错:', err)
      return { data: null, error: err }
    }
  },
  
  // 删除对话
  async deleteConversation(id: string) {
    const { supabase } = useSupabase()
    
    try {
      const { error } = await supabase
        .from('conversations')
        .delete()
        .eq('id', id)
      
      if (error) {
        console.error('删除对话失败:', error)
        return { error }
      }
      
      return { error: null }
    } catch (err) {
      console.error('删除对话出错:', err)
      return { error: err }
    }
  },
  
  // 从本地存储加载对话历史（用于离线模式）
  getLocalConversations() {
    try {
      const { user } = useSupabase()
      const userId = user.value?.id || 'anonymous'
      const storageKey = `conversations_${userId}`
      
      const savedConversations = localStorage.getItem(storageKey)
      if (savedConversations) {
        return JSON.parse(savedConversations)
      }
    } catch (error) {
      console.error('从本地存储加载对话历史失败:', error)
    }
    return []
  },
  
  // 保存对话历史到本地存储（用于离线模式）
  saveLocalConversation(conversation: Conversation) {
    try {
      const { user } = useSupabase()
      const userId = user.value?.id || 'anonymous'
      const storageKey = `conversations_${userId}`
      
      // 获取现有对话
      let conversations = this.getLocalConversations()
      
      // 检查是否已存在该对话
      const index = conversations.findIndex((c: Conversation) => c.id === conversation.id)
      if (index !== -1) {
        conversations[index] = conversation
      } else {
        conversations.unshift(conversation)
      }
      
      // 限制每个数智人最多保存20条对话
      const botConversations: { [key: string]: Conversation[] } = {}
      
      // 按数智人ID分组
      conversations.forEach((conv: Conversation) => {
        if (!botConversations[conv.bot_id]) {
          botConversations[conv.bot_id] = []
        }
        botConversations[conv.bot_id].push(conv)
      })
      
      // 限制每个数智人的对话记录数量
      let newConversations: Conversation[] = []
      Object.keys(botConversations).forEach(botId => {
        newConversations = newConversations.concat(botConversations[botId].slice(0, 20))
      })
      
      // 保存到本地存储，使用用户ID作为键的一部分
      localStorage.setItem(storageKey, JSON.stringify(newConversations))
      return true
    } catch (error) {
      console.error('保存对话历史到本地存储失败:', error)
      return false
    }
  },
  
  // 根据ID从本地存储获取特定对话
  getLocalConversationById(id: string) {
    try {
      const conversations = this.getLocalConversations()
      return { 
        conversation: conversations.find((c: Conversation) => c.id === id) || null,
        error: null
      }
    } catch (error) {
      console.error('从本地存储获取特定对话失败:', error)
      return { conversation: null, error }
    }
  }
} 