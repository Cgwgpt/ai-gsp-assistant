# 使用统计实时更新问题排查指南

## 问题症状
使用次数没有自动实时更新，需要手动刷新页面才能看到最新数据。

## 解决方案

### 1. 检查 Supabase Realtime 是否已启用

#### 方法1：通过 Supabase Dashboard
1. 登录 Supabase Dashboard
2. 进入你的项目
3. 导航到 **Database** > **Replication**
4. 找到 `usage_metrics` 表
5. 确保该表的实时功能已启用（开关应该是打开状态）

#### 方法2：通过 SQL 查询
在 Supabase SQL Editor 中执行：
```sql
SELECT 
  schemaname,
  tablename
FROM pg_publication_tables 
WHERE pubname = 'supabase_realtime' 
  AND tablename = 'usage_metrics';
```

如果查询返回空结果，说明需要启用实时功能。

#### 方法3：手动启用（如果需要）
```sql
ALTER PUBLICATION supabase_realtime ADD TABLE usage_metrics;
```

### 2. 检查数据库中的数据更新

执行诊断脚本（`检查使用统计实时更新.sql`）：
```sql
-- 检查最近的更新
SELECT 
  user_id,
  bot_id,
  conversation_count,
  token_count,
  updated_at,
  NOW() - updated_at as time_since_update
FROM usage_metrics
ORDER BY updated_at DESC
LIMIT 20;
```

### 3. 检查浏览器控制台日志

打开浏览器开发者工具（F12），查看控制台日志：

#### 正常情况应该看到：
```
[使用统计] 设置实时订阅监听...
[使用统计] 用户ID: xxx-xxx-xxx
[使用统计] 实时订阅已设置，等待连接...
[使用统计] 实时订阅状态: SUBSCRIBED
[使用统计] ✅ 实时订阅已成功建立
```

#### 如果实时订阅失败，会看到：
```
[使用统计] 实时订阅状态: CHANNEL_ERROR
[使用统计] ❌ 实时订阅失败，请检查 Supabase Realtime 是否已启用
```

#### 当数据库更新时，应该看到：
```
[使用统计] ✅ 检测到数据库变化: {
  eventType: "UPDATE",
  new: {...},
  old: {...},
  timestamp: "2024-..."
}
[使用统计] 开始刷新数据（由实时订阅触发）
```

### 4. 测试实时更新

1. **打开使用情况页面**（`/usage`）
2. **打开浏览器控制台**（F12）
3. **发送一条消息**（在聊天界面）
4. **观察控制台日志**：
   - 应该看到 `[使用统计] ✅ 检测到数据库变化`
   - 使用次数应该自动更新

### 5. 备用方案：轮询更新

如果实时订阅失败，系统会自动使用轮询方式：
- 每30秒自动刷新一次
- 每5秒轮询一次（如果实时订阅完全失败）

### 6. 常见问题

#### Q: 实时订阅一直显示 CHANNEL_ERROR
**A:** 
1. 检查 Supabase Dashboard 中 `usage_metrics` 表的实时功能是否已启用
2. 检查网络连接是否正常
3. 检查 Supabase 项目配置是否正确

#### Q: 数据库有更新，但前端没有刷新
**A:**
1. 检查浏览器控制台是否有错误
2. 检查实时订阅状态是否为 `SUBSCRIBED`
3. 检查 `user_id` 是否匹配（实时订阅只监听当前用户的数据）

#### Q: 刷新后数据正确，但不自动更新
**A:**
1. 确认实时订阅已成功建立（检查控制台日志）
2. 确认 Supabase Realtime 已启用
3. 尝试刷新页面重新建立连接

### 7. 验证步骤

1. ✅ 在 Supabase Dashboard 中启用 `usage_metrics` 表的实时功能
2. ✅ 打开使用情况页面，查看控制台日志
3. ✅ 确认看到 `✅ 实时订阅已成功建立`
4. ✅ 发送一条消息
5. ✅ 确认看到 `✅ 检测到数据库变化`
6. ✅ 确认使用次数自动更新

### 8. 调试工具

已创建以下调试工具：
- `检查使用统计实时更新.sql` - SQL 诊断脚本
- `supabase/migrations/enable_realtime_for_usage_metrics.sql` - 启用实时功能的 SQL

### 9. 技术细节

#### 实时订阅机制
- 使用 Supabase Realtime 的 `postgres_changes` 事件
- 监听 `usage_metrics` 表的所有变化（INSERT, UPDATE, DELETE）
- 只监听当前用户的数据（通过 `user_id` 过滤）

#### 更新逻辑
1. 数据库更新 → Supabase Realtime 推送事件
2. 前端接收事件 → 触发 `loadUserUsage()` 刷新数据
3. 防抖机制：延迟 0.5 秒刷新，避免频繁更新

#### 备用机制
- Loading 状态监听：监听 `chatStore.loading` 变化
- 轮询更新：每30秒自动刷新（备用）
- 如果实时订阅失败，使用5秒轮询

## 总结

使用统计实时更新的核心是：
1. **Supabase Realtime 必须启用**（最关键）
2. **前端实时订阅必须成功建立**
3. **数据库更新必须触发实时事件**

如果以上都正常，使用次数应该会自动实时更新。

