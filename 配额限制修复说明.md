# 配额限制修复说明

## 问题描述

之前的配额检查函数存在逻辑错误：
- **问题**：无论配额类型（全局或特定数智人），函数都只检查特定数智人的使用量
- **影响**：当用户有全局配额限制（如10次）时，函数只检查当前数智人的使用量（如5次），错误地通过了检查
- **结果**：前端显示全局使用量15/10（已超限），但检查仍然通过，导致消息仍然可以发送

## 修复内容

已修复SQL函数 `check_user_conversation_quota`，使其根据配额类型正确检查使用量：

1. **全局配额**（`bot_id IS NULL`）：检查全局使用量（所有数智人的总和）
2. **特定数智人配额**：检查该数智人的使用量

## 应用修复

### 方法1：在 Supabase Dashboard 中执行

1. 登录 [Supabase Dashboard](https://app.supabase.com)
2. 选择您的项目
3. 进入 **SQL Editor**
4. 复制并执行以下SQL脚本：

```sql
-- 文件位置: supabase/migrations/fix_check_user_conversation_quota_function.sql
-- 修复 check_user_conversation_quota 函数，添加 SECURITY DEFINER
-- 这样可以确保函数可以绕过 RLS 策略访问数据
-- 修复：根据配额类型（全局或特定数智人）检查对应的使用量
CREATE OR REPLACE FUNCTION check_user_conversation_quota(
  p_user_id UUID,
  p_bot_id UUID
) RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_quota INTEGER;
  v_quota_bot_id UUID;  -- 记录配额类型（NULL表示全局配额，非NULL表示特定数智人配额）
  v_current_count INTEGER;
  v_current_month_start DATE;
  v_current_month_end DATE;
BEGIN
  -- 获取当前月份的起止日期
  v_current_month_start := date_trunc('month', CURRENT_DATE)::DATE;
  v_current_month_end := (date_trunc('month', CURRENT_DATE) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;
  
  -- 获取用户针对特定数智人的配额
  SELECT max_conversations, bot_id INTO v_quota, v_quota_bot_id
  FROM user_quotas
  WHERE user_id = p_user_id AND bot_id = p_bot_id;
  
  -- 如果没有找到特定配额，检查全局配额
  IF v_quota IS NULL THEN
    SELECT max_conversations, bot_id INTO v_quota, v_quota_bot_id
    FROM user_quotas
    WHERE user_id = p_user_id AND bot_id IS NULL;
  END IF;
  
  -- 如果配额为-1或null，表示无限制
  IF v_quota IS NULL OR v_quota = -1 THEN
    RETURN TRUE;
  END IF;
  
  -- 根据配额类型决定检查范围：
  -- 1. 如果配额是全局配额（v_quota_bot_id IS NULL），则检查全局使用量（所有数智人的总和）
  -- 2. 如果配额是特定数智人配额（v_quota_bot_id IS NOT NULL），则检查该数智人的使用量
  IF v_quota_bot_id IS NULL THEN
    -- 全局配额：计算所有数智人的使用量总和
    SELECT COALESCE(SUM(conversation_count), 0) INTO v_current_count
    FROM usage_metrics
    WHERE user_id = p_user_id 
      AND bot_id IS NOT NULL  -- 只统计数智人的使用量，不包括全局记录
      AND period_start = v_current_month_start
      AND period_end = v_current_month_end;
  ELSE
    -- 特定数智人配额：只检查该数智人的使用量
    SELECT conversation_count INTO v_current_count
    FROM usage_metrics
    WHERE user_id = p_user_id 
      AND bot_id = p_bot_id
      AND period_start = v_current_month_start
      AND period_end = v_current_month_end;
    
    -- 如果没有统计记录，表示当前使用量为0
    IF v_current_count IS NULL THEN
      v_current_count := 0;
    END IF;
  END IF;
  
  -- 检查是否超额
  -- 明确返回布尔值：如果使用量小于配额，返回true（允许）；否则返回false（禁止）
  IF v_current_count < v_quota THEN
    RETURN TRUE;
  ELSE
    RETURN FALSE;
  END IF;
END;
$$;
```

### 方法2：直接执行修复文件

如果您使用 Supabase CLI，可以直接执行：

```bash
# 在项目根目录执行
supabase db execute -f supabase/migrations/fix_check_user_conversation_quota_function.sql
```

## 验证修复

### 1. 检查函数是否正确创建

在 Supabase SQL Editor 中执行：

```sql
-- 检查函数是否存在且使用了 SECURITY DEFINER
SELECT 
  proname as function_name,
  prosecdef as is_security_definer,
  CASE 
    WHEN prosecdef = true THEN '✅ 已设置 SECURITY DEFINER'
    ELSE '❌ 未设置 SECURITY DEFINER'
  END as status
FROM pg_proc 
WHERE proname = 'check_user_conversation_quota';
```

**预期结果**：`is_security_definer` 应该为 `true`

### 2. 测试函数逻辑

找一个已超限的用户进行测试：

```sql
-- 替换为实际的用户ID和botID
-- 对于全局配额用户，当使用量 >= 配额时，应该返回 false
SELECT check_user_conversation_quota(
  'your-user-id-here'::UUID,
  'your-bot-id-here'::UUID
) as function_result;
```

**预期结果**：
- 如果用户使用量 < 配额：返回 `true`
- 如果用户使用量 >= 配额：返回 `false`

### 3. 查看前端行为

1. 使用一个已达到配额限制的用户登录
2. 尝试发送消息
3. **预期行为**：应该显示错误提示"您已达到本月对话次数限制"，并阻止消息发送

## 修复后的行为

修复后，配额检查将正确工作：

### 场景1：全局配额限制

- **配额设置**：用户有全局配额限制（如10次），`bot_id IS NULL`
- **检查逻辑**：计算所有数智人的使用量总和
- **结果**：如果总和 >= 10，返回 `false`，阻止消息发送

### 场景2：特定数智人配额限制

- **配额设置**：用户对特定数智人有配额限制（如5次），`bot_id = 'specific-bot-id'`
- **检查逻辑**：只检查该数智人的使用量
- **结果**：如果该数智人使用量 >= 5，返回 `false`，阻止消息发送

## 注意事项

1. **立即生效**：修复后，配额检查会立即生效
2. **无需重启**：数据库函数修改后无需重启应用
3. **向后兼容**：修复不会影响现有数据，只是修正了检查逻辑

## 相关文件

- `supabase/migrations/fix_check_user_conversation_quota_function.sql` - 修复脚本
- `supabase/migrations/create_usage_metrics.sql` - 原始migration文件（已更新）
- `services/usageService.ts` - 配额检查服务（调用修复后的函数）
- `stores/chat.ts` - 消息发送逻辑（使用配额检查）

## 问题排查

如果修复后仍然有问题，请检查：

1. **函数是否正确部署**
   ```sql
   SELECT proname, prosecdef FROM pg_proc WHERE proname = 'check_user_conversation_quota';
   ```

2. **配额数据是否正确**
   ```sql
   SELECT * FROM user_quotas WHERE user_id = 'your-user-id';
   ```

3. **使用量数据是否正确**
   ```sql
   SELECT * FROM usage_metrics 
   WHERE user_id = 'your-user-id' 
   AND period_start = date_trunc('month', CURRENT_DATE)::DATE;
   ```

4. **前端日志**
   - 打开浏览器控制台
   - 查看 `[配额检查]` 相关的日志
   - 确认函数返回值和错误信息

